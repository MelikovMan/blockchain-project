version: '3.7'
services:
  regulator-agent:
    image: bcgovimages/aries-cloudagent:py3.12_1.2.0
    container_name: regulator_agent
    environment:
      # Идентификация регулятора
      - ACAPY_LABEL=State_Medical_Regulator
      
      # Административный API для контроллера
      - ACAPY_ADMIN=["0.0.0.0", "8041"]
      - ACAPY_ADMIN_API_KEY=regulator-admin-key-789
      
      # Публичный DID регулятора (главный эндоузер в сети)
      - ACAPY_WALLET_SEED=state_regulator_seed_00000000001
      - ACAPY_ENDORSER_ROLE=ENDORSER
      
      # Кошелек
      - ACAPY_WALLET_KEY=StrongRegulatorWalletKey789
      - ACAPY_WALLET_NAME=StateRegulatorWallet
      
      # Сеть Indy
      - ACAPY_GENESIS_URL=http://172.17.0.1:9000/genesis
      
      # Транспорты
      - ACAPY_ENDPOINT=http://regulator-agent:8040
      - ACAPY_INBOUND_TRANSPORT=[["http", "0.0.0.0", "8040"]]
      - ACAPY_OUTBOUND_TRANSPORT=["http"]
      
      # Автоматизация и политики
      - ACAPY_AUTO_PROVISION=true
      - ACAPY_AUTO_ACCEPT_INVITES=true
      - ACAPY_AUTO_ACCEPT_REQUESTS=true
      
      # РЕЖИМ ЭНДОУЗЕРА - ключевое изменение
      - ACAPY_ENDORSER_PROTOCOL_ROLE=endorser
      - ACAPY_AUTO_ENDORSE_TRANSACTIONS=true  # Автоматически подписываем транзакции от одобренных учреждений
      
      # Webhook для контроллера регулятора
      - ACAPY_WEBHOOK_URL=http://172.17.0.1:8070/webhooks
      
      # Конфигурация для управления транзакциями
      - ACAPY_ENDORSER_CONNECTION_ID_AUTO_ACCEPT=true
      - ACAPY_ENDORSER_ENDORSE_ALL=true
      - ACAPY_ENDORSER_AUTO_ENDORSE=true
      
      # Мониторинг транзакций от больниц
      - ACAPY_NOTIFY_REVOCATION=true
      - ACAPY_NOTIFY_ENDORSEMENT=true
    ports:
      - "8040:8040"  # Для сообщений между агентами
      - "8041:8041"  # Административный API
    volumes:
      - regulator_wallet_data:/home/aries/.acapy_agent/wallet/StateRegulatorWallet
    user: root
    command: >
      start
      --endpoint http://regulator-agent:8040
      --auto-provision
      --auto-accept-invites
      --auto-accept-requests
      --endorser-protocol-role endorser
      --auto-endorse-transactions
volumes:
 regulator_wallet_data: